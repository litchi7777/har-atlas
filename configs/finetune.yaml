# Fine-tuning Configuration

# Dataset
dataset_type: "sensor"

sensor_data:
  # データセットの基本設定
  data_root: "har-unified-dataset/data/processed"  # データルートディレクトリ

  # データセットとセンサー位置のペア（grid_searchで上書き）
  # 各ペアは [データセット名, センサー位置] の形式
  dataset_location_pairs:
    - ["dsads", "Torso"]  # デフォルト: DSADS Torso

  # バッチローダー設定
  batch_loader:
    exclude_patterns: []  # 除外パターン（例: ["USER00001"]）
    sample_threshold: 50  # 使用しないが、バリデーションのため保持
    batch_size: 200  # バッチサイズ（前の設定に合わせて高速化）

  # ユーザー分割設定
  user_split:
    test_users: ["1", "2"]  # テスト用ユーザーID
    val_users: ["3", "4"]   # 検証用ユーザーID
    # train_users は指定なし（test/val以外の全ユーザー）

# Model
model:
  name: "resnet"
  backbone: "resnet"
  num_classes: 6  # NHANESのクラス数（後で自動検出される）
  pretrained_path: null  # 事前学習済みモデルのパス（nullの場合はランダム初期化）
  freeze_backbone: false

# Data Augmentation
augmentation:
  mode: "light"

# Training
training:
  epochs: 60
  learning_rate: 0.0005  # 最適学習率
  weight_decay: 0.0001
  optimizer: "adam"
  scheduler: "step"  # step, cosine, plateau
  step_size: 20
  gamma: 0.1
  max_samples_per_epoch: 10000  # 最適設定: 10k samples

# Loss Function
loss:
  type: "cross_entropy"  # cross_entropy, focal_loss, etc.
  label_smoothing: 0.1

# Hardware
device: "cuda"
multi_gpu: false
mixed_precision: true

# Checkpointing
checkpoint:
  save_best: true
  metric: "val_accuracy"  # val_accuracy, val_loss
  resume: null

# Evaluation
evaluation:
  eval_interval: 1  # evaluate every N epochs
  metrics: ["accuracy", "f1", "precision", "recall"]

# Weights & Biases
wandb:
  enabled: true
  project: "har-foundation"
  group: null  # 自動生成（job_type + タイムスタンプ）。手動設定も可能
  job_type: "finetune"
  entity: null
  name: null
  tags: []
  notes: null

# Early Stopping
early_stopping:
  patience: 10  # 最適設定
  min_delta: 0.0001

# Seed for reproducibility
seed: 42

# Grid Search（オプション）
# 3つの事前学習モデル × 複数データセット・部位 × 3ランダムシードで検証
grid_search:
  seed:
    - 42
    - 123
    - 456
  sensor_data:
    dataset_location_pairs:
      # 手・腕部位
      - [["pamap2", "hand"]]           # PAMAP2: 手 (12クラス)
      - [["mhealth", "RightWrist"]]    # MHEALTH: 右手首 (12クラス)
      - [["dsads", "RightArm"]]        # DSADS: 右腕 (19クラス)
      - [["forthtrace", "RightWrist"]] # FORTHTRACE: 右手首 (16クラス)
      # 胴体・腰部位
      - [["dsads", "Torso"]]           # DSADS: 胴体 (19クラス)
      - [["mhealth", "Chest"]]         # MHEALTH: 胸 (12クラス)
      - [["har70plus", "LowerBack"]]   # HAR70PLUS: 腰 (7クラス)
      - [["harth", "LowerBack"]]       # HARTH: 腰 (12クラス)
      # 足部位
      - [["dsads", "RightLeg"]]        # DSADS: 右足 (19クラス)
      - [["mhealth", "LeftAnkle"]]     # MHEALTH: 左足首 (12クラス)
      - [["forthtrace", "LeftAnkle"]]  # FORTHTRACE: 左足首 (16クラス)
  model:
    pretrained_path:
      # Supervised Learning (from scratch) - ベースライン
      - null  # 事前学習なし（ランダム初期化）のみ実行

settings:
  stop_on_error: false
  save_summary: true
  parallel: true
  experiments_per_gpu: 4  # 1つのGPUで同時実行する実験数
  max_workers: null  # nullの場合は available_gpus × experiments_per_gpu で自動計算 (4 GPUs × 4 = 16)
  available_gpus: [0, 1, 2, 3]
