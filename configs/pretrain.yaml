# Pre-training Configuration

# Dataset
dataset_type: "sensor"

sensor_data:
  # データセットの基本設定
  data_root: "har-unified-dataset/data/processed"  # データルートディレクトリ
  datasets: ["openpack"]  # 使用するデータセット名

  # センサー部位の設定
  # - "all": すべてのデバイスを使用（マルチデバイスモデル）
  # - ["hand"]: 特定のデバイスのみ使用（シングルデバイスモデル）
  # - ["hand", "chest"]: 複数の特定デバイスを使用（マルチデバイスモデル）
  sensor_location: ["hand"]

  # バッチローダー設定
  batch_loader:
    exclude_patterns: []  # 除外パターン（例: ["USER00001"]）
    sample_threshold: 1000  # 最小サンプル数（1ファイルあたり）
    batch_size: 4  # 1バッチに含める被験者（ファイル）数
    train_num_samples: 1000  # エポックあたりのサンプル数
    val_num_samples: 100
    test_num_samples: 100

# Model
model:
  name: "resnet"
  backbone: "resnet"
  feature_dim: 256
  projection_dim: 128

# Multitask Learning
multitask:
  enabled: true
  # SSLタスクの設定
  # - binary_*: 変換予測タスク（binary_permute, binary_reverse, binary_timewarp）
  # - masking_*: マスク再構成タスク（masking_channel, masking_time, masking_time_channel）
  # - contrastive_*: 対照学習タスク（将来拡張用）
  ssl_tasks: ["binary_permute", "binary_reverse", "binary_timewarp"]
  task_weights: [1.0, 1.0, 1.0]
  apply_prob: 0.5  # binary_*タスクの適用確率
  mask_ratio: 0.15  # masking_*タスクのマスク比率

# Data Augmentation
augmentation:
  enabled: false  # データ拡張を無効化（シンプル化のため）
  # mode: "mtl"  # light, medium, heavy, mtl

# Training
training:
  epochs: 50
  learning_rate: 0.001
  weight_decay: 0.0001
  optimizer: "adam"
  scheduler: "cosine"
  warmup_epochs: 10
  eta_min: 0.0005  # 最小学習率（初期値の1/2）
  grad_clip_norm: 1.0  # 勾配クリッピング（1.0推奨、無効化する場合はnull）

# Hardware
device: "cuda:0"
mixed_precision: true

# Checkpointing
checkpoint:
  save_freq: 10

# Early Stopping
early_stopping:
  enabled: false  # Early Stoppingを有効化（長時間学習時に推奨）
  patience: 20    # 改善が見られないエポック数
  min_delta: 0.001  # 改善と見なす最小変化量

# Weights & Biases
wandb:
  enabled: true
  project: "har-foundation"
  group: null  # 自動生成（job_type + タイムスタンプ）。手動設定も可能
  job_type: "pretrain"
  entity: null
  name: null
  tags: []
  notes: null

# Seed
seed: 42

# Grid Search
# PAMAP2/OpenPackのデバイス × バックボーン × SSLタスク × 事前学習パスでSSL事前学習
# 実行: python train.py pretrain
grid_search:
  sensor_data:
    sensor_location:
      - ["atr01"] 
      - ["atr02"]
      - ["atr03"]
      - ["atr04"]
  model:
    backbone:
      - "resnet"           # Resnet (デフォルト)
    pretrained_path:
      - null  # ゼロから学習
      - "experiments/pretrain/run_20251104_082803/ssl_tasks=['binary_permute', 'binary_reverse', 'binary_timewarp', 'masking_time_channel']/models/checkpoint_epoch_97.pth"  # 既存checkpointから継続学習
  multitask:
    ssl_tasks:
      - ["binary_permute", "binary_reverse", "binary_timewarp", "masking_time_channel"]

# OpenPackで実験する場合は、以下のように変更してください:
# 1. datasets: ["pamap2"] -> ["openpack"] に変更
# 2. sensor_location: ["hand"], ["chest"], ["ankle"] -> ["atr01"], ["atr02"], ["atr03"], ["atr04"] に変更

settings:
  stop_on_error: false
  save_summary: true
  summary_path: "logs/pretrain_experiments_summary.json"
  parallel: true  # GPU並列実行
  max_workers: null  # null=利用可能なGPU全て、数値=最大並列数
