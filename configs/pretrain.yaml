# Pre-training Configuration

# Dataset
dataset_type: "sensor"

sensor_data:
  # データセットの基本設定
  data_root: "har-unified-dataset/data/processed"  # データルートディレクトリ

  # ウィンドウサイズ設定
  window_size: 60  # デフォルト: 2.0秒 @ 30Hz（grid_searchでオーバーライド）
  original_window_size: 150  # 元データの5.0秒 @ 30Hz

  # ウィンドウクリップ設定（5秒→指定サイズへ）
  window_clip:
    enabled: true
    strategy: "random"  # random, center, start, end

  # データセットとセンサー位置のペアを指定（必須）
  # 各ペアは [データセット名, センサー位置] の形式
  # 全データセット × 全装着位置（回転不変性学習のため全身のデータを使用）
  dataset_location_pairs:
    # CHAD (1 locations)
    - ["chad", "Pocket"]
    # DSADS (5 locations)
    - ["dsads", "LeftArm"]
    - ["dsads", "LeftLeg"]
    - ["dsads", "RightArm"]
    - ["dsads", "RightLeg"]
    - ["dsads", "Torso"]
    # FORTHTrace (5 locations)
    - ["forthtrace", "LeftAnkle"]
    - ["forthtrace", "LeftWrist"]
    - ["forthtrace", "RightThigh"]
    - ["forthtrace", "RightWrist"]
    - ["forthtrace", "Torso"]
    # HAR70+ (2 locations)
    - ["har70plus", "LowerBack"]
    - ["har70plus", "RightThigh"]
    # HARTH (2 locations)
    - ["harth", "LowerBack"]
    - ["harth", "RightThigh"]
    # HHAR (10 locations)
    - ["hhar", "gear_1"]
    - ["hhar", "gear_2"]
    - ["hhar", "lgwatch_1"]
    - ["hhar", "lgwatch_2"]
    - ["hhar", "nexus4_1"]
    - ["hhar", "nexus4_2"]
    - ["hhar", "s3_1"]
    - ["hhar", "s3_2"]
    - ["hhar", "s3mini_1"]
    - ["hhar", "s3mini_2"]
    # LARA (5 locations)
    - ["lara", "LeftArm"]
    - ["lara", "LeftLeg"]
    - ["lara", "Neck"]
    - ["lara", "RightArm"]
    - ["lara", "RightLeg"]
    # MEX (2 locations)
    - ["mex", "Thigh"]
    - ["mex", "Wrist"]
    # MHEALTH (3 locations)
    - ["mhealth", "Chest"]
    - ["mhealth", "LeftAnkle"]
    - ["mhealth", "RightWrist"]
    # NHANES (1 locations)
    - ["nhanes", "PAX"]
    # OPENPACK (4 locations)
    - ["openpack", "atr01"]
    - ["openpack", "atr02"]
    - ["openpack", "atr03"]
    - ["openpack", "atr04"]
    # PAAL (1 locations)
    - ["paal", "Wrist"]
    # PAMAP2 (3 locations)
    - ["pamap2", "ankle"]
    - ["pamap2", "chest"]
    - ["pamap2", "hand"]
    # RealDisp (9 locations)
    - ["realdisp", "Back"]
    - ["realdisp", "LeftCalf"]
    - ["realdisp", "LeftLowerArm"]
    - ["realdisp", "LeftThigh"]
    - ["realdisp", "LeftUpperArm"]
    - ["realdisp", "RightCalf"]
    - ["realdisp", "RightLowerArm"]
    - ["realdisp", "RightThigh"]
    - ["realdisp", "RightUpperArm"]
    # SelfBACK (2 locations)
    - ["selfback", "Thigh"]
    - ["selfback", "Wrist"]
    # TMD (1 locations)
    - ["tmd", "Smartphone"]
    # USCHAD (1 locations)
    - ["uschad", "Hip"]
    # 合計: 17データセット × 57ペア（19ペア→57ペアに拡張）

  # バッチローダー設定
  batch_loader:
    exclude_patterns: []  # 除外パターン（例: ["USER00001"]）
    sample_threshold: 2000  # 最小サンプル数（1ファイルあたり）
    batch_size: 4  # 1バッチに含める被験者（ファイル）数
    train_num_samples: 1000  # エポックあたりのサンプル数
    val_num_samples: 100
    test_num_samples: 100

# Model
model:
  name: "resnet"
  backbone: "resnet"
  feature_dim: 256
  projection_dim: 128

# Multitask Learning
multitask:
  enabled: true
  # SSLタスクの設定
  # - binary_*: 変換予測タスク（binary_permute, binary_reverse, binary_timewarp）
  # - masking_*: マスク再構成タスク（masking_channel, masking_time, masking_time_channel）
  # - contrastive_*: 対照学習タスク（将来拡張用）
  # - invariant_*: 不変性学習タスク（invariant_orientation: 向き不変性）
  ssl_tasks: ["binary_permute", "binary_reverse", "binary_timewarp", "invariant_orientation"]
  task_weights: [1.0, 1.0, 1.0, 1.0] # invariant_orientationの重みを1.0に設定
  apply_prob: 0.5  # binary_*タスクの適用確率
  mask_ratio: 0.15  # masking_*タスクのマスク比率

# Data Augmentation
augmentation:
  enabled: false  # データ拡張を無効化（シンプル化のため）
  # mode: "mtl"  # light, medium, heavy, mtl

# Rotation Augmentation（回転拡張）
rotation_augmentation:
  enabled: true  # すべてのSSLタスクに回転拡張を適用（バッチ内の偏り解消）
  rotation_type: "random"  # random: SO(3)完全ランダム, gravity_preserving: Z軸保持

# Training
training:
  epochs: 100
  learning_rate: 0.0001  # 継続学習のため学習率を下げる（0.001 → 0.0001）
  weight_decay: 0.0001
  optimizer: "adam"
  scheduler: "cosine"
  warmup_epochs: 5  # 継続学習なのでwarmupを短縮
  eta_min: 0.00005  # 最小学習率（初期値の1/2）
  grad_clip_norm: 1.0  # 勾配クリッピング（1.0推奨、無効化する場合はnull）

# Hardware
device: "cuda:3"
mixed_precision: true

# Checkpointing
checkpoint:
  save_freq: 10

# Early Stopping
early_stopping:
  enabled: false  # Early Stoppingを有効化（長時間学習時に推奨）
  patience: 20    # 改善が見られないエポック数
  min_delta: 0.001  # 改善と見なす最小変化量

# Weights & Biases
wandb:
  enabled: true
  project: "har-foundation"
  group: null  # 自動生成（job_type + タイムスタンプ）。手動設定も可能
  job_type: "pretrain"
  entity: null
  name: null
  tags: ["window_size_experiments", "primitive_discovery"]
  notes: "Pre-training with multiple window sizes (2.0s, 1.0s, 0.5s) for motion primitive discovery"

# Seed
seed: 42

# Grid Search
# 実行: python train.py pretrain
# 回転拡張のAblation Study + ウィンドウサイズ比較
# 合計: 2（回転あり/なし） × 3（ウィンドウサイズ） = 6実験
grid_search:
  sensor_data:
    # ウィンドウサイズの比較実験（プリミティブ粒度の探索）
    window_size:
      #- 15   # 0.5秒 @ 30Hz（アトミックプリミティブ）
      #- 60   # 2.0秒 @ 30Hz（完全プリミティブ）
      - 150  # 5.0秒 @ 30Hz（長期プリミティブ）

  rotation_augmentation:
    # 回転拡張のAblation Study
    enabled:
      - false  # Baseline: 回転拡張なし
      - true   # Proposed: 回転拡張あり

  model:
    pretrained_path:
      - null
  multitask:
    ssl_tasks:
      # 既存3タスク + 向き不変性
      - ["binary_permute", "binary_reverse", "binary_timewarp", "invariant_orientation"]


settings:
  stop_on_error: false
  save_summary: true
  # summary_pathを指定しない場合、自動的にexperiments/*/run_*/summary.jsonに保存される
  parallel: true  # GPU並列実行
  experiments_per_gpu: 1  # 1つのGPUで同時実行する実験数（Pretrainは1推奨）
  max_workers: null  # nullの場合は available_gpus × experiments_per_gpu で自動計算
  available_gpus: [2,3]  # 使用するGPUのリスト（例: [0, 1, 3]で複数GPU指定可能）
