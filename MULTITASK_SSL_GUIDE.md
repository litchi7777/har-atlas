# ãƒãƒ«ãƒã‚¿ã‚¹ã‚¯SSLå®Ÿè£…ã‚¬ã‚¤ãƒ‰

## æ¦‚è¦

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ã€å¤‰æ›äºˆæ¸¬ã‚¿ã‚¹ã‚¯ï¼ˆ**binary_***ï¼‰ã¨ãƒã‚¹ã‚¯å†æ§‹æˆã‚¿ã‚¹ã‚¯ï¼ˆ**masking_***ï¼‰ã®ä¸¡æ–¹ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹çµ±åˆå‹Self-Supervised Learning (SSL) ã‚·ã‚¹ãƒ†ãƒ ã‚’æä¾›ã—ã¾ã™ã€‚

## ã‚µãƒãƒ¼ãƒˆã™ã‚‹ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—

### 1. å¤‰æ›äºˆæ¸¬ã‚¿ã‚¹ã‚¯ï¼ˆBinary Tasksï¼‰

ãƒ‡ãƒ¼ã‚¿æ‹¡å¼µãŒé©ç”¨ã•ã‚ŒãŸã‹ã©ã†ã‹ã‚’äºˆæ¸¬ã™ã‚‹2å€¤åˆ†é¡ã‚¿ã‚¹ã‚¯ã€‚

| ã‚¿ã‚¹ã‚¯å | èª¬æ˜ | æ‹¡å¼µå†…å®¹ |
|---------|------|---------|
| `binary_permute` | ã‚»ã‚°ãƒ¡ãƒ³ãƒˆä¸¦ã¹æ›¿ãˆæ¤œå‡º | æ™‚ç³»åˆ—ã‚’è¤‡æ•°ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã«åˆ†å‰²ã—ã¦ãƒ©ãƒ³ãƒ€ãƒ ã«ä¸¦ã¹æ›¿ãˆ |
| `binary_reverse` | æ™‚é–“åè»¢æ¤œå‡º | æ™‚ç³»åˆ—ã‚’æ™‚é–“è»¸ã§åè»¢ |
| `binary_timewarp` | æ™‚é–“ãƒ¯ãƒ¼ãƒ”ãƒ³ã‚°æ¤œå‡º | æ™‚é–“è»¸ã‚’éç·šå½¢ã«ä¼¸ç¸® |

**å‡ºåŠ›**: 2ã‚¯ãƒ©ã‚¹ã®ãƒ­ã‚¸ãƒƒãƒˆ (batch_size, 2)
**æå¤±é–¢æ•°**: CrossEntropyLoss

### 2. ãƒã‚¹ã‚¯å†æ§‹æˆã‚¿ã‚¹ã‚¯ï¼ˆMasking Tasksï¼‰

ãƒã‚¹ã‚¯ã•ã‚ŒãŸéƒ¨åˆ†ã‚’å…ƒã®ãƒ‡ãƒ¼ã‚¿ã«å¾©å…ƒã™ã‚‹å†æ§‹æˆã‚¿ã‚¹ã‚¯ã€‚

| ã‚¿ã‚¹ã‚¯å | èª¬æ˜ | ãƒã‚¹ã‚¯å¯¾è±¡ |
|---------|------|-----------|
| `masking_channel` | ãƒãƒ£ãƒ³ãƒãƒ«ãƒã‚¹ã‚­ãƒ³ã‚° | ãƒ©ãƒ³ãƒ€ãƒ ã«ãƒãƒ£ãƒ³ãƒãƒ«å…¨ä½“ã‚’ãƒã‚¹ã‚¯ |
| `masking_time` | æ™‚é–“ãƒã‚¹ã‚­ãƒ³ã‚° | ãƒ©ãƒ³ãƒ€ãƒ ã«æ™‚é–“ã‚¹ãƒ†ãƒƒãƒ—ã‚’ãƒã‚¹ã‚¯ |
| `masking_time_channel` | æ™‚é–“-ãƒãƒ£ãƒ³ãƒãƒ«åŒæ™‚ãƒã‚¹ã‚­ãƒ³ã‚° | æ™‚é–“ã¨ãƒãƒ£ãƒ³ãƒãƒ«ã®ä¸¡æ–¹ã‚’ãƒã‚¹ã‚¯ |

**å‡ºåŠ›**: å†æ§‹æˆã•ã‚ŒãŸæ™‚ç³»åˆ— (batch_size, channels, time_steps)
**æå¤±é–¢æ•°**: MSELossï¼ˆå¹³å‡äºŒä¹—èª¤å·®ï¼‰

### 3. å¯¾ç…§å­¦ç¿’ã‚¿ã‚¹ã‚¯ï¼ˆContrastive Tasksï¼‰

å°†æ¥æ‹¡å¼µç”¨ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã€‚

| ã‚¿ã‚¹ã‚¯å | èª¬æ˜ |
|---------|------|
| `contrastive_simclr` | SimCLRé¢¨ã®å¯¾ç…§å­¦ç¿’ï¼ˆæœªå®Ÿè£…ï¼‰ |

## ä½¿ã„æ–¹

### 1. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ç·¨é›†

`configs/pretrain.yaml`ï¼ˆã¾ãŸã¯ã‚«ã‚¹ã‚¿ãƒ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ã§ä½¿ç”¨ã™ã‚‹ã‚¿ã‚¹ã‚¯ã‚’æŒ‡å®šã—ã¾ã™ã€‚

```yaml
# Multitask Learning
multitask:
  enabled: true

  # SSLã‚¿ã‚¹ã‚¯ã®ãƒªã‚¹ãƒˆ
  ssl_tasks: ["binary_permute", "binary_reverse", "binary_timewarp"]

  # å„ã‚¿ã‚¹ã‚¯ã®æå¤±é‡ã¿
  task_weights: [1.0, 1.0, 1.0]

  # binary_*ã‚¿ã‚¹ã‚¯ã®é©ç”¨ç¢ºç‡
  apply_prob: 0.5

  # masking_*ã‚¿ã‚¹ã‚¯ã®ãƒã‚¹ã‚¯æ¯”ç‡
  mask_ratio: 0.15
```

### 2. ã‚¿ã‚¹ã‚¯ã®çµ„ã¿åˆã‚ã›ä¾‹

#### ä¾‹1: å¤‰æ›äºˆæ¸¬ã®ã¿ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰

```yaml
ssl_tasks: ["binary_permute", "binary_reverse", "binary_timewarp"]
task_weights: [1.0, 1.0, 1.0]
apply_prob: 0.5
```

#### ä¾‹2: ãƒã‚¹ã‚¯å†æ§‹æˆã®ã¿

```yaml
ssl_tasks: ["masking_channel", "masking_time", "masking_time_channel"]
task_weights: [1.0, 1.0, 1.0]
mask_ratio: 0.15
```

#### ä¾‹3: å¤‰æ›äºˆæ¸¬ã¨ãƒã‚¹ã‚¯å†æ§‹æˆã®æ··åˆ

```yaml
ssl_tasks: ["binary_permute", "binary_reverse", "masking_channel", "masking_time"]
task_weights: [1.0, 1.0, 1.0, 1.0]
apply_prob: 0.5
mask_ratio: 0.15
```

#### ä¾‹4: ãƒãƒ£ãƒ³ãƒãƒ«ãƒã‚¹ã‚­ãƒ³ã‚°ã®ã¿ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ï¼‰

```yaml
ssl_tasks: ["masking_channel"]
task_weights: [1.0]
mask_ratio: 0.2  # 20%ã®ãƒãƒ£ãƒ³ãƒãƒ«ã‚’ãƒã‚¹ã‚¯
```

### 3. ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã®å®Ÿè¡Œ

#### ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã§ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°

```bash
python train.py pretrain
```

#### ã‚«ã‚¹ã‚¿ãƒ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨

```bash
python src/training/pretrain.py --config configs/pretrain_masking.yaml
```

#### ãƒã‚¹ã‚¯å†æ§‹æˆã‚¿ã‚¹ã‚¯ã®ã¿ï¼ˆã‚µãƒ³ãƒ—ãƒ«è¨­å®šï¼‰

```bash
python src/training/pretrain.py --config configs/pretrain_masking.yaml
```

#### æ··åˆã‚¿ã‚¹ã‚¯ï¼ˆã‚µãƒ³ãƒ—ãƒ«è¨­å®šï¼‰

```bash
python src/training/pretrain.py --config configs/pretrain_mixed.yaml
```

### 4. ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ

å®Ÿè£…ãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã‹ç¢ºèªã™ã‚‹ãŸã‚ã®çµ±åˆãƒ†ã‚¹ãƒˆï¼š

```bash
python test_multitask_ssl.py
```

å‡ºåŠ›ä¾‹ï¼š
```
================================================================================
Multi-Task SSL Implementation Test
================================================================================

âœ… Augmentation classes test passed!
âœ… Binary tasks test passed!
âœ… Masking tasks test passed!
âœ… Mixed tasks test passed!

ğŸ‰ All tests passed!
```

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ãƒ¢ãƒ‡ãƒ«æ§‹é€ 

```
å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ (batch, channels, time_steps)
    â†“
å…±æœ‰ãƒãƒƒã‚¯ãƒœãƒ¼ãƒ³ (ResNet)
    â†“
ç‰¹å¾´ãƒãƒƒãƒ— (batch, 512, 1)
    â†“
ã‚¿ã‚¹ã‚¯å›ºæœ‰ãƒ˜ãƒƒãƒ‰ (ModuleDict)
    â”œâ”€ binary_*ã‚¿ã‚¹ã‚¯ â†’ åˆ†é¡ãƒ˜ãƒƒãƒ‰ â†’ (batch, 2)
    â”œâ”€ masking_*ã‚¿ã‚¹ã‚¯ â†’ ãƒ‡ã‚³ãƒ¼ãƒ€ãƒ¼ãƒ˜ãƒƒãƒ‰ â†’ (batch, channels, time_steps)
    â””â”€ contrastive_*ã‚¿ã‚¹ã‚¯ â†’ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ãƒ˜ãƒƒãƒ‰ â†’ (batch, 128)
```

### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

#### Binaryæ‹¡å¼µã‚¿ã‚¹ã‚¯

```
å…ƒãƒ‡ãƒ¼ã‚¿ â†’ æ‹¡å¼µé©ç”¨ï¼ˆç¢ºç‡apply_probï¼‰ â†’ ãƒ¢ãƒ‡ãƒ« â†’ 2ã‚¯ãƒ©ã‚¹äºˆæ¸¬ â†’ CrossEntropyæå¤±
```

#### Maskingã‚¿ã‚¹ã‚¯

```
å…ƒãƒ‡ãƒ¼ã‚¿ â†’ ãƒã‚¹ã‚­ãƒ³ã‚°é©ç”¨ â†’ ãƒ¢ãƒ‡ãƒ« â†’ å†æ§‹æˆãƒ‡ãƒ¼ã‚¿ â†’ MSEæå¤±ï¼ˆå…ƒãƒ‡ãƒ¼ã‚¿ã¨ã®å·®ï¼‰
```

### æå¤±é–¢æ•°

å„ã‚¿ã‚¹ã‚¯ã®æå¤±ã‚’é‡ã¿ä»˜ãå’Œã§çµåˆï¼š

```python
total_loss = Î£ (task_weight[i] * task_loss[i])
```

## è¨­å®šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

### multitaskã‚»ã‚¯ã‚·ãƒ§ãƒ³

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | å‹ | èª¬æ˜ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ |
|-----------|---|------|-----------|
| `enabled` | bool | ãƒãƒ«ãƒã‚¿ã‚¹ã‚¯å­¦ç¿’ã‚’æœ‰åŠ¹åŒ– | `true` |
| `ssl_tasks` | list[str] | SSLã‚¿ã‚¹ã‚¯ã®ãƒªã‚¹ãƒˆ | `["binary_permute", ...]` |
| `task_weights` | list[float] | å„ã‚¿ã‚¹ã‚¯ã®é‡ã¿ | `[1.0, 1.0, 1.0]` |
| `apply_prob` | float | binary_*ã‚¿ã‚¹ã‚¯ã®é©ç”¨ç¢ºç‡ | `0.5` |
| `mask_ratio` | float | masking_*ã‚¿ã‚¹ã‚¯ã®ãƒã‚¹ã‚¯æ¯”ç‡ | `0.15` |

## å®Ÿè£…ã®è©³ç´°

### ä¸»è¦ãªãƒ•ã‚¡ã‚¤ãƒ«

| ãƒ•ã‚¡ã‚¤ãƒ« | èª¬æ˜ |
|---------|------|
| [src/models/sensor_models.py](src/models/sensor_models.py) | `IntegratedSSLModel` - ã‚¿ã‚¹ã‚¯å›ºæœ‰ãƒ˜ãƒƒãƒ‰ã‚’æŒã¤çµ±åˆãƒ¢ãƒ‡ãƒ« |
| [src/losses/ssl_losses.py](src/losses/ssl_losses.py) | `IntegratedSSLLoss` - ãƒãƒ«ãƒã‚¿ã‚¹ã‚¯æå¤±é–¢æ•° |
| [src/data/augmentations.py](src/data/augmentations.py) | `ChannelMasking`, `TimeMasking` - ãƒã‚¹ã‚­ãƒ³ã‚°æ‹¡å¼µã‚¯ãƒ©ã‚¹ |
| [src/data/batch_dataset.py](src/data/batch_dataset.py) | `MultiTaskSubjectWiseLoader` - ãƒãƒ«ãƒã‚¿ã‚¹ã‚¯å¯¾å¿œãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ€ãƒ¼ |
| [src/training/pretrain.py](src/training/pretrain.py) | ãƒ—ãƒªãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¹ã‚¯ãƒªãƒ—ãƒˆ |

### ãƒ¢ãƒ‡ãƒ«ã®æ‹¡å¼µ

æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—ã‚’è¿½åŠ ã™ã‚‹å ´åˆï¼š

1. **ã‚¿ã‚¹ã‚¯åã®å®šç¾©**: `{prefix}_{task_name}` å½¢å¼ï¼ˆä¾‹: `binary_rotation`ï¼‰
2. **ãƒ¢ãƒ‡ãƒ«ãƒ˜ãƒƒãƒ‰ã®è¿½åŠ **: `IntegratedSSLModel._create_task_head()` ã«åˆ†å²ã‚’è¿½åŠ 
3. **æå¤±é–¢æ•°ã®è¿½åŠ **: `IntegratedSSLLoss._get_loss_fn()` ã«å¯¾å¿œã™ã‚‹æå¤±é–¢æ•°ã‚’è¿½åŠ 
4. **ãƒ‡ãƒ¼ã‚¿æ‹¡å¼µã®å®Ÿè£…**: `src/data/augmentations.py` ã«æ‹¡å¼µã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
5. **ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ€ãƒ¼ã®æ›´æ–°**: `MultiTaskSubjectWiseLoader.__getitem__()` ã§ãƒ©ãƒ™ãƒ«ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ 

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### 1. ãƒ¡ãƒ¢ãƒªä¸è¶³ã‚¨ãƒ©ãƒ¼

ãƒã‚¹ã‚¯å†æ§‹æˆã‚¿ã‚¹ã‚¯ã¯å‡ºåŠ›ãŒå¤§ãã„ãŸã‚ã€ãƒãƒƒãƒã‚µã‚¤ã‚ºã‚’æ¸›ã‚‰ã—ã¦ãã ã•ã„ï¼š

```yaml
sensor_data:
  batch_loader:
    batch_size: 2  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 4
```

### 2. æå¤±ãŒNaNã«ãªã‚‹

- ãƒã‚¹ã‚¯æ¯”ç‡ãŒå¤§ãã™ãã‚‹å¯èƒ½æ€§ â†’ `mask_ratio` ã‚’å°ã•ãï¼ˆä¾‹: 0.1ï¼‰
- å­¦ç¿’ç‡ãŒé«˜ã™ãã‚‹å¯èƒ½æ€§ â†’ `learning_rate` ã‚’å°ã•ãï¼ˆä¾‹: 0.0001ï¼‰

### 3. ã‚¿ã‚¹ã‚¯ã”ã¨ã®æå¤±ã®ãƒãƒ©ãƒ³ã‚¹ãŒæ‚ªã„

`task_weights` ã‚’èª¿æ•´ã—ã¦å„ã‚¿ã‚¹ã‚¯ã®å½±éŸ¿åº¦ã‚’å¤‰æ›´ï¼š

```yaml
# maskingã‚¿ã‚¹ã‚¯ã®é‡ã¿ã‚’å¤§ããã™ã‚‹ä¾‹
ssl_tasks: ["binary_permute", "masking_channel"]
task_weights: [1.0, 2.0]
```

## ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### 1. ã‚¿ã‚¹ã‚¯ã®é¸æŠ

- **å¤‰æ›äºˆæ¸¬ã®ã¿**: é«˜é€Ÿã€ãƒ¡ãƒ¢ãƒªåŠ¹ç‡çš„ã€ã‚·ãƒ³ãƒ—ãƒ«
- **ãƒã‚¹ã‚¯å†æ§‹æˆã®ã¿**: ã‚ˆã‚Šè±Šã‹ãªç‰¹å¾´è¡¨ç¾ã€è¨ˆç®—ã‚³ã‚¹ãƒˆé«˜
- **æ··åˆ**: ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸã‚¢ãƒ—ãƒ­ãƒ¼ãƒã€å¤šæ§˜ãªç‰¹å¾´å­¦ç¿’

### 2. ãƒã‚¤ãƒ‘ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

| è¨­å®š | æ¨å¥¨å€¤ | ç†ç”± |
|------|--------|------|
| `apply_prob` | 0.5 | åŠåˆ†ã¯å…ƒãƒ‡ãƒ¼ã‚¿ã€åŠåˆ†ã¯æ‹¡å¼µãƒ‡ãƒ¼ã‚¿ã§å­¦ç¿’ |
| `mask_ratio` | 0.10-0.20 | é©åº¦ãªæƒ…å ±æ¬ è½ã§å†æ§‹æˆã‚’å­¦ç¿’ |
| `task_weights` | å‡ç­‰ï¼ˆ1.0ï¼‰ | ã¾ãšã¯å‡ç­‰ã«ã€ãã®å¾Œèª¿æ•´ |

### 3. å®Ÿé¨“ã®é€²ã‚æ–¹

1. **ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³**: ã¾ãšå¤‰æ›äºˆæ¸¬ã‚¿ã‚¹ã‚¯ã®ã¿ã§å®Ÿé¨“
2. **ãƒã‚¹ã‚¯å†æ§‹æˆ**: æ¬¡ã«ãƒã‚¹ã‚¯å†æ§‹æˆã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ 
3. **ãƒã‚¤ãƒ‘ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ¢ç´¢**: ã‚°ãƒªãƒƒãƒ‰ã‚µãƒ¼ãƒã§æœ€é©ãªçµ„ã¿åˆã‚ã›ã‚’ç™ºè¦‹
4. **ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°**: æœ€è‰¯ã®ãƒ¢ãƒ‡ãƒ«ã§ä¸‹æµã‚¿ã‚¹ã‚¯ã‚’è©•ä¾¡

## å‚è€ƒæ–‡çŒ®

### å¤‰æ›äºˆæ¸¬ã‚¿ã‚¹ã‚¯

- **Permutation/Reverse**: æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ã®é †åºæƒ…å ±ã‚’å­¦ç¿’
- **TimeWarping**: æ™‚é–“è»¸ã®ä¸å¤‰æ€§ã‚’å­¦ç¿’

### ãƒã‚¹ã‚¯å†æ§‹æˆã‚¿ã‚¹ã‚¯

- **BERT (NLP)**: Masked Language Modeling ã®æ™‚ç³»åˆ—ç‰ˆ
- **MAE (Vision)**: Masked Autoencoder ã®æ™‚ç³»åˆ—ç‰ˆ

## ã¾ã¨ã‚

ã“ã®å®Ÿè£…ã«ã‚ˆã‚Šã€ä»¥ä¸‹ãŒå¯èƒ½ã«ãªã‚Šã¾ã—ãŸï¼š

âœ… å¤‰æ›äºˆæ¸¬ã¨ãƒã‚¹ã‚¯å†æ§‹æˆã®**ä¸¡æ–¹**ã‚’ã‚µãƒãƒ¼ãƒˆ
âœ… è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã§**æŸ”è»Ÿ**ã«ã‚¿ã‚¹ã‚¯ã‚’çµ„ã¿åˆã‚ã›å¯èƒ½
âœ… çµ±ä¸€çš„ãªã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã§**ç°¡å˜**ã«æ–°ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ 
âœ… **æ‹¡å¼µæ€§**ã®é«˜ã„è¨­è¨ˆï¼ˆå¯¾ç…§å­¦ç¿’ç­‰ã«ã‚‚å¯¾å¿œå¯èƒ½ï¼‰

å®Ÿé¨“ã‚’æ¥½ã—ã‚“ã§ãã ã•ã„ï¼ğŸš€
